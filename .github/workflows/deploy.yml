name: Terraform Build-and-Deploy Azure Function

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  terraform-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          auth-type: service_principal

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -input=false

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve -input=false

      - name: Get Terraform outputs (safe)
        id: tfoutputs
        working-directory: terraform
        run: |
          # Read the outputs that exist in your state (you reported these names)
          FN=$(terraform output -raw function_name_name 2>/dev/null | sed -n '1p' | tr -d '\r')
          RG=$(terraform output -raw resource_group 2>/dev/null | sed -n '1p' | tr -d '\r')

          echo "Captured FN='$FN'"
          echo "Captured RG='$RG'"

          # Write to GITHUB_ENV using the heredoc form (safe for any content)
          {
            printf 'FUNCTION_NAME<<EOF\n'
            printf '%s\n' "$FN"
            printf 'EOF\n'
          } >> $GITHUB_ENV

          {
            printf 'RG<<EOF\n'
            printf '%s\n' "$RG"
            printf 'EOF\n'
          } >> $GITHUB_ENV

          # Also write to GITHUB_OUTPUT for job outputs
          {
            printf 'function_name<<EOF\n'
            printf '%s\n' "$FN"
            printf 'EOF\n'
          } >> $GITHUB_OUTPUT

          {
            printf 'resource_group<<EOF\n'
            printf '%s\n' "$RG"
            printf 'EOF\n'
          } >> $GITHUB_OUTPUT

      - name: Show repo layout (debug)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          echo "Repo root listing:"
          ls -la
          echo "Looking for likely function source folders..."
          find . -maxdepth 4 -type d \( -iname "*function*" -o -iname "function-src" -o -iname "src" \) -print || true

      - name: Locate function source folder
        id: findfunc
        run: |
          # prefer exact folder names in order of likelihood
          CANDIDATES=(
            "src/function"
            "function-src"
            "function"
            "src"
            "."
          )
          FOUND=""
          for d in "${CANDIDATES[@]}"; do
            if [ -d "$GITHUB_WORKSPACE/$d" ]; then
              FOUND="$d"
              break
            fi
          done

          # fallback: try to discover first folder named *function*
          if [ -z "$FOUND" ]; then
            DISCOVERED=$(find . -maxdepth 3 -type d -iname "*function*" -print -quit || true)
            if [ -n "$DISCOVERED" ]; then
              # strip leading ./ if present
              FOUND="${DISCOVERED#./}"
            fi
          fi

          if [ -z "$FOUND" ]; then
            echo "No function source folder found in repo. Creating src/function and attempting to copy function-src if present."
            mkdir -p src/function
            if [ -d "function-src" ]; then
              cp -r function-src/* src/function/ || true
              FOUND="src/function"
            else
              # leave FOUND empty to fail later with clear message
              FOUND=""
            fi
          fi

          if [ -z "$FOUND" ]; then
            echo "##[error]Could not find a function source folder. Please place your function app code in one of: src/function, function-src, function, src, or root."
            exit 1
          fi

          echo "function_dir=$FOUND" >> $GITHUB_OUTPUT
          echo "FUNCTION_DIR=$FOUND" >> $GITHUB_ENV
          echo "Found function folder: $FOUND"

      - name: Build Function (npm) if package.json present
        run: |
          # read location from env
          DIR="${FUNCTION_DIR:-src/function}"
          echo "Building function at: $DIR"
          if [ ! -d "$DIR" ]; then
            echo "##[error]Directory $DIR does not exist (unexpected). Aborting."
            ls -la
            exit 1
          fi

          cd "$DIR"

          if [ ! -f package.json ]; then
            echo "No package.json in $DIR — skipping npm install/build. Creating a zip of contents anyway."
          else
            echo "package.json found — running npm install"
            npm install
            # run build if it exists
            if grep -q "\"build\"" package.json; then
              npm run build || true
            fi
          fi

          # produce deployment zip at repo root
          ZIP="$GITHUB_WORKSPACE/function-package.zip"
          echo "Creating zip at $ZIP"
          cd "$DIR"
          zip -r "$ZIP" . >/dev/null
          echo "Created $ZIP with size: $(stat -c%s "$ZIP") bytes"

      - name: Deploy Function App (zip)
        run: |
          if [ -z "$FUNCTION_NAME" ] || [ -z "$RG" ]; then
            echo "##[error] FUNCTION_NAME or RG is empty. Ensure terraform outputs were captured."
            echo "FUNCTION_NAME='$FUNCTION_NAME' RG='$RG'"
            exit 1
          fi

          echo "Deploying $FUNCTION_NAME to resource group $RG"
          # az login already performed by azure/login earlier in the job
          az functionapp deployment source config-zip \
            --resource-group "$RG" \
            --name "$FUNCTION_NAME" \
            --src "$GITHUB_WORKSPACE/function-package.zip"
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
